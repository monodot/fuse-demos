<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
             http://www.osgi.org/xmlns/blueprint/v1.0.0 https://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
             http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">


    <bean class="com.mysql.jdbc.jdbc2.optional.MysqlDataSource" id="myDS">
        <property name="serverName" value="localhost"></property>
        <property name="databaseName" value="customers"></property>
        <property name="port" value="3306"></property>
        <property name="user" value="customers"></property>
        <property name="password" value="customers"></property>
    </bean>

    <bean id="jmsConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory">
        <property name="brokerURL" value="tcp://localhost:61616"/>
        <property name="userName" value="admin"/>
        <property name="password" value="admin"/>
    </bean>

    <bean id="pooledConnectionFactory" class="org.apache.activemq.pool.PooledConnectionFactory" init-method="start" destroy-method="stop">
        <property name="maxConnections" value="8"/>
        <property name="connectionFactory" ref="jmsConnectionFactory"/>
    </bean>

    <bean id="jmsConfig" class="org.apache.camel.component.jms.JmsConfiguration">
        <property name="connectionFactory" ref="pooledConnectionFactory"/>
        <property name="concurrentConsumers" value="10"/>
    </bean>

    <bean id="activemq" class="org.apache.activemq.camel.component.ActiveMQComponent">
        <property name="configuration" ref="jmsConfig"/>
    </bean>


    <camelContext id="blueprint-service-context" xmlns="http://camel.apache.org/schema/blueprint">

        <route id="initialiseDatabase">
            <from uri="timer:initDB?delay=1000&amp;repeatCount=1"/>
            <to uri="sql:CREATE TABLE customers ( name VARCHAR(100) )?dataSource=#myDS"/>
        </route>

        <route id="timerToLog">
            <from uri="timer:foo?delay=5000&amp;period=10000"/>
            <transacted/>
            <setBody>
                <simple>Hello, world!</simple>
            </setBody>
            <log message="The message contains ${body}"/>
            <to uri="activemq:queue:FOO"/>
            <to uri="activemq:queue:FOO"/>
            <to uri="activemq:queue:FOO"/>
            <to uri="activemq:queue:FOO"/>
            <to uri="activemq:queue:FOO"/>
            <to uri="sql:INSERT INTO customers ( namez ) VALUES ( 'hello' )?dataSource=#myDS"/>
        </route>

    </camelContext>



</blueprint>
