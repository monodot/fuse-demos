<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
    xsi:schemaLocation="
             http://www.osgi.org/xmlns/blueprint/v1.0.0 https://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
             http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">

    <cm:property-placeholder persistent-id="com.cleverbuilder.fusedemos.simplejmstransaction">
        <cm:default-properties>
            <cm:property name="exception.throw" value="false"/>
        </cm:default-properties>
    </cm:property-placeholder>



    <bean id="jmsConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory">
        <property name="brokerURL" value="tcp://localhost:61616"/>
        <property name="userName" value="admin"/>
        <property name="password" value="admin"/>
    </bean>

    <bean id="jmsConfig" class="org.apache.camel.component.jms.JmsConfiguration">
        <property name="connectionFactory" ref="jmsConnectionFactory"/>
        <property name="transactionManager" ref="jmsTransactionManager"/>
        <property name="transacted" value="true"/>
    </bean>

    <bean id="jmstx" class="org.apache.camel.component.jms.JmsComponent">
        <property name="configuration" ref="jmsConfig" />
    </bean>

    <bean id="jmsTransactionManager" class="org.springframework.jms.connection.JmsTransactionManager">
        <property name="connectionFactory" ref="jmsConnectionFactory" />
    </bean>

    <camelContext id="blueprint-service-context" xmlns="http://camel.apache.org/schema/blueprint">

        <route id="timerToJMS">
            <from uri="timer:foo?delay=5000&amp;period=10000"/>
            <!-- Enables transacted sending and receiving of messages in InOnly mode. -->
            <!-- The JmsConfiguration should also have transacted=true set -->
            <transacted/>
            <setBody>
                <simple>Hello, world!</simple>
            </setBody>
            <log message="The message contains ${body}"/>
            <to uri="jmstx:queue:FOO"/>
            <to uri="jmstx:queue:FOO"/>
            <to uri="jmstx:queue:FOO"/>
            <to uri="jmstx:queue:FOO"/>
            <to uri="jmstx:queue:FOO"/>
            <choice>
                <when>
                    <simple>'{{exception.throw}}' == 'true'</simple>
                    <throwException exceptionType="java.lang.Exception" message="Just throwing an error here!"/>
                </when>
            </choice>
            
        </route>

    </camelContext>



</blueprint>
